# 飞书多维表格权限配置指南

## 问题说明
错误码 `91403 Forbidden` 表示应用没有权限写入多维表格。

## 解决方案

### 步骤 1：在飞书开放平台配置应用权限

1. 访问 https://open.feishu.cn/app
2. 找到并点击您的应用：`AbaqusGuard` 或 `cli_a9e82413e7785cc2`
3. 进入 **权限管理** 页面
4. 搜索并开启以下权限：
   - ✅ `bitable:app` - 查看、编辑多维表格（必需）
   - ✅ `bitable:app:readonly` - 只读多维表格（可选）
5. 点击 **保存** 或 **发布**

### 步骤 2：授予应用对多维表格的访问权限

有两种方式，**至少选择一种**：

#### 方式 A：在多维表格中添加应用（推荐）

1. 打开您的飞书多维表格
2. 点击右上角的 **⚙️ 设置** 或 **协作** 按钮
3. 点击 **添加协作者** 或 **管理协作者**
4. 在搜索框中输入应用名称：`AbaqusGuard`（不是 App ID）
5. 选择应用后，设置权限为 **可编辑**
6. 点击 **确认** 或 **邀请**

#### 方式 B：在开放平台申请权限

1. 回到应用详情页
2. 进入 **权限管理** > **获取权限**
3. 找到多维表格相关权限
4. 点击 **申请权限**
5. 选择要访问的多维表格（从下拉列表中选择）
6. 提交申请并等待企业管理员批准

### 步骤 3：验证权限配置

权限配置完成后：

1. **等待权限生效**：通常需要 1-2 分钟
2. **重新运行测试**：
   ```bash
   uv run python test_bitable_permission.py
   ```

如果看到 ✅ 成功消息，说明权限配置成功！

### 步骤 4：更新 config.toml

确认 `config.toml` 中的配置：

```toml
[bitable]
enable = true
app_id = "cli_a9e82413e7785cc2"
app_secret = "WbjA1aNpp301lVBJGObyGbU2oS1E2Pzu"
app_token = "OJHmb2kLNau92usQZS2ctK1NnIc"
table_id = "tbl5dDCMUlMDkft5"
```

### 步骤 5：启动监控

```bash
uv run python run.py
```

## 常见问题

### Q1: 权限配置后仍然报错 91403？

**A**: 请检查：
1. 是否在**权限管理**中开启了 `bitable:app` 权限
2. 是否在**多维表格设置**中添加了应用为协作者
3. 是否等待了 1-2 分钟让权限生效
4. 应用是否有管理员权限（有些企业需要管理员审批）

### Q2: 如何找到应用名称？

**A**: 
- 应用名称不是 `cli_a9e82413e7785cc2`（这是 App ID）
- 应用名称是您创建应用时设置的名字，如 `AbaqusGuard`
- 在开放平台应用列表中可以看到应用名称

### Q3: 应用没有在协作者搜索中显示？

**A**: 
- 确认应用已发布（不是草稿状态）
- 确认应用在同一飞书租户下
- 尝试使用 App ID 搜索：`cli_a9e82413e7785cc2`

### Q4: 是企业应用还是个人应用？

**A**: 
- 个人应用：直接在多维表格中添加应用即可
- 企业应用：需要企业管理员批准权限申请

### Q5: 权限申请被拒绝怎么办？

**A**: 
- 联系飞书企业管理员
- 说明这是用于监控作业的工具
- 申请 `bitable:app` 权限

## 快速检查清单

在测试前，请确认以下项目：

- [ ] 应用已在开放平台配置 `bitable:app` 权限
- [ ] 应用已在多维表格中添加为协作者（权限：可编辑）
- [ ] 等待了 1-2 分钟让权限生效
- [ ] config.toml 中的 app_token 和 table_id 正确
- [ ] 应用状态为"已发布"（不是草稿）
- [ ] 如果是企业应用，已获得管理员批准

## 调试技巧

如果仍然遇到问题，可以：

1. **查看详细日志**：
   ```python
   client = BitableClient(
       app_id="cli_a9e82413e7785cc2",
       app_secret="WbjA1aNpp301lVBJGObyGbU2oS1E2Pzu",
       verbose=True  # 开启详细日志
   )
   ```

2. **检查飞书开放平台日志**：
   - 在应用详情页查看 API 调用日志
   - 查看是否有权限拒绝的记录

3. **联系飞书技术支持**：
   - 访问 https://open.feishu.cn/support
   - 提供错误码：`91403`
   - 提供应用 ID：`cli_a9e82413e7785cc2`

## 成功示例

成功时应该看到：

```
测试创建记录...
[Lark] [DEBUG] POST https://open.feishu.cn/open-apis/bitable/v1/... 200
[BitableClient] 创建记录成功: record_id=reclXXXXX
权限配置成功！记录 ID: reclXXXXX
```

状态码应该是 `200`，不是 `403`。
